// dot -Tsvg -o images/state.svg state.dot

digraph A {
    node [shape=rect];

    Closed [label="Closed (initial state)"]

    Closed -> Listen [label="listen"]
    Closed -> SynSent [label="connect\n&rarr; SYN"]

    Listen -> SynReceived [label="SYN\n&rarr; SYN+ACK"]
    Listen -> Closed [label="close", style=dotted]
    SynReceived -> Listen [label="RST", style=dotted]
    SynReceived -> Established [label="ACK"]

    SynSent -> Established [label="SYN+ACK\n&rarr; ACK"]
    SynSent -> Closed [label="close", style=dotted]

    // s{0,1,2} = our FIN no/send/ack?
    // f{0,2} = their FIN no/ack?
    // w{?} = variant enters timewait
    //
    // s0f0 = Established

	subgraph cluster_pc {
		label = < <b>Passive Close</b> >;

        s0f2 [label="CloseWait"]
        s1f2 [label="LastAck"]
    }

    subgraph cluster_ac {
		label = < <b>Active Close</b> >;

        s1f0w [label="FinWait1"]
        s1f2w [label="Simultaneous close"]
        s2f0w [label="FinWait2"]
        s2f2w [label="TimeWait"]
	}

    s2f2 [label="Closed (back to start)"]

    Established -> s1f0w [label="shutdown\n&rarr; FIN"]


    Established -> s0f2 [label="FIN\n&rarr; ACK"]

    s1f0w -> s1f2w [label="FIN\n&rarr; ACK"]
    s2f0w -> s2f2w [label="FIN\n&rarr; ACK"]

    s1f2 -> s2f2 [label="ACK"]
    s1f0w -> s2f0w [label="ACK"]
    s1f2w -> s2f2w [label="ACK"]

    s0f2 -> s1f2 [label="shutdown\n&rarr; FIN"]

    s2f2w -> s2f2 [label="timeout"]
}